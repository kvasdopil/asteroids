<!DOCTYPE html>
<html>
<head>
  <title>Asteroids</title>
  <style type="text/css">
    body {
      height: 100vh;
      margin: 0;
      display: flex;
    }
  </style>
  <script src="./three.min.js"></script>
</head>
<body>
  <script type="text/javascript">
    const HEIGHT = 150;
    const WIDTH = HEIGHT * (window.innerWidth / window.innerHeight)

    const camera = new THREE.PerspectiveCamera( 70, window.innerWidth / window.innerHeight, 0.01, 100 );
    camera.position.z = 100;
    camera.position.x = WIDTH / 2;
    camera.position.y = HEIGHT / 2;

    const scene = new THREE.Scene();

    const ship = createShip();
    ship.position.x = WIDTH / 2;
    ship.position.y = HEIGHT / 2;

    function createShip() {
      var geometry = new THREE.ConeGeometry(1, 3, 4);
      const material = new THREE.MeshNormalMaterial();

      const ship = new THREE.Mesh( geometry, material );

      scene.add( ship );
      ship.speed = {x: 0, y: 0};

      return ship;
    }

    const fireballs = [];
    const asteroids = [];
    function createFireball() {
      var geometry = new THREE.SphereGeometry(0.5, 4, 4);
      const material = new THREE.MeshNormalMaterial();
      const ball = new THREE.Mesh( geometry, material );
      ball.visible = false;
      scene.add( ball );
      fireballs.push(ball);
      return ball;
    }

    function createAsteroid(size) {
      var geometry = new THREE.OctahedronGeometry(size, 1);
      const material = new THREE.MeshNormalMaterial();
      const ball = new THREE.Mesh( geometry, material );
      ball.position.x = Math.random() * WIDTH;
      ball.position.y = Math.random() * HEIGHT;
      ball.sz = size;
      ball.speed = {
        x: 0.1 * (Math.random() * 2 - 1),
        y: 0.1 * (Math.random() * 2 - 1),
        rz: (0.1 / size) * (Math.random() * 2 - 1),
        rx: (0.1 / size) * (Math.random() * 2 - 1),
        ry: (0.1 / size) * (Math.random() * 2 - 1),
      };
      scene.add( ball );
      asteroids.push(ball);
      return ball;
    }

    function crackAsteroid(asteroid) {
      asteroid.visible = false;
      if(asteroid.sz < 4) {
        return;
      }

      const a1 = createAsteroid(asteroid.sz - 2);
      const a2 = createAsteroid(asteroid.sz - 2);
      const a3 = createAsteroid(asteroid.sz - 2);

      a1.position.x = asteroid.position.x; //TODO: shift a bit
      a1.position.y = asteroid.position.y;

      a2.position.x = asteroid.position.x; //TODO: shift a bit
      a2.position.y = asteroid.position.y;

      a3.position.x = asteroid.position.x; //TODO: shift a bit
      a3.position.y = asteroid.position.y;

      // TODO: randomize this
      a1.position.add(new THREE.Vector3(asteroid.sz / 1.2, -1 * asteroid.sz / 1.2, 0));
      a2.position.sub(new THREE.Vector3(-1 * asteroid.sz / 1.2, asteroid.sz / 1.2, 0));
      a3.position.sub(new THREE.Vector3(asteroid.sz / 1.5, asteroid.sz / 1.5, 0));

      a1.speed = {...asteroid.speed};
      a1.speed.x += (1/asteroid.sz) * Math.random();

      a2.speed = {...asteroid.speed};
      a2.speed.x -= (1/asteroid.sz) * Math.random();

      a3.speed = {...asteroid.speed};
      a3.speed.x -= (1/asteroid.sz) * Math.random();
      a3.speed.y -= (1/asteroid.sz) * Math.random();
    }

    function fire() {
      const fireball = fireballs.find(a => !a.visible) || createFireball();
      fireball.speed = {
        x: -1 * Math.sin(ship.rotation.z) + ship.speed.x,
        y: Math.cos(ship.rotation.z) + ship.speed.y,
      };
      fireball.position.x = ship.position.x;
      fireball.position.y = ship.position.y;
      fireball.visible = true;
      fireball.lifetime = new Date().getTime() + 1000;
    }

    const renderer = new THREE.WebGLRenderer( { antialias: true } );
    renderer.setSize( window.innerWidth, window.innerHeight );
    document.body.appendChild( renderer.domElement );

    for (var i = 0; i<10; i++)
      createAsteroid(Math.random() * 8 + 1);

    const keys = {};

    document.onkeydown = event => keys[event.key] = 1;
    document.onkeyup = event => keys[event.key] = 0;

    function collideAsteroids(a1, a2) {
      const v1 = a1.position.clone().sub(a2.position);
      const m1m2 = a1.sz / a2.sz;
      const m2m1 = a2.sz / a1.sz;
      x1 = a2.speed.x;
      y2 = a2.speed.y;
      a2.speed.x = a1.speed.x * m1m2; // - v1.x * 0.003;
      a2.speed.y = a1.speed.y * m1m2; // - v1.y * 0.003;
      a1.speed.x = x1 * m2m1; // + v1.x * 0.003;
      a1.speed.y = y2 * m2m1; // + v1.y * 0.003;
    }

    let gameOver = false;

    function animate() {
      if(gameOver) {
        return;
      }
      requestAnimationFrame( animate );
      const t = new Date().getTime();

      if (keys.ArrowUp) {
        ship.speed.x = ship.speed.x - Math.sin(ship.rotation.z) * 0.01;
        ship.speed.y = ship.speed.y + Math.cos(ship.rotation.z) * 0.01;
      }
      if (keys[' ']) {
        fire();
        keys[' '] = 0;
      }
      if (keys.ArrowLeft) {
        ship.rotation.z += 0.1;
      }
      if (keys.ArrowRight) {
        ship.rotation.z -= 0.1;
      }

      ship.position.x = (WIDTH + ship.position.x + ship.speed.x) % WIDTH;
      ship.position.y = (HEIGHT + ship.position.y + ship.speed.y) % HEIGHT;

      fireballs.map(ball => {
        if (ball.visible) {
          if (ball.lifetime < t) {
            ball.visible = false;
          } else {
            ball.position.x = (WIDTH + ball.position.x + ball.speed.x) % WIDTH;
            ball.position.y = (HEIGHT + ball.position.y + ball.speed.y) % HEIGHT;
          }
        }
      });

      asteroids.map(asteroid => {
        if (asteroid.visible) {
          // if (ball.lifetime < t) {
          //   ball.visible = false;
          //   ball.position.x = -9999; // -9999;
          // } else {
            asteroid.position.x = (WIDTH + asteroid.position.x + asteroid.speed.x) % WIDTH;
            asteroid.position.y = (HEIGHT + asteroid.position.y + asteroid.speed.y) % HEIGHT;
            asteroid.rotation.z = asteroid.rotation.z + asteroid.speed.rz;
            asteroid.rotation.x = asteroid.rotation.x + asteroid.speed.rx;
            asteroid.rotation.y = asteroid.rotation.y + asteroid.speed.ry;
          //}
        }
      });

      fireballs.map(ball => {
        asteroids.map(asteroid => {
          if(ball.visible && asteroid.visible) {
            if(ball.position.distanceTo(asteroid.position) <= asteroid.sz) {
              ball.visible = false;
              crackAsteroid(asteroid);
            }
          }
        })
      });

      const aa = asteroids.filter(a => a.visible);

      aa.map(oid => {
        if(oid.position.distanceTo(ship.position) <= oid.sz) {
          gameOver = true;
        }
      })

      for(let i = 0; i<aa.length; i++)
        for(let j=0; j<i; j++) {
          if(aa[i].position.distanceTo(aa[j].position) <= (aa[i].sz + aa[j].sz)) {
            collideAsteroids(aa[i], aa[j]);
          }
        }
      renderer.render( scene, camera );
    }

    animate();
  </script>
</body>
</html>